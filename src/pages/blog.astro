---
import Layout from '../layouts/Layout.astro';
import FeaturedArticle from '../components/FeaturedArticle.astro';
import BlogFilter from '../components/BlogFilter';
import { getCollection, getEntry } from 'astro:content';
import type { BlogPost } from '../components/BlogFilter';

interface ImageData {
  url: string;
  width: number;
  height: number;
}

const wpPosts = await getCollection('posts');
const wpCategories = await getCollection('categories');

const categoryNames = wpCategories.map(cat => cat.data.name);

function stripHtml(html: string): string {
  return html
    .replace(/<[^>]*>/g, '')
    .replace(/&nbsp;/g, ' ')
    .replace(/&hellip;/g, '...')
    .replace(/&#8217;/g, "'")
    .replace(/&#8220;/g, '"')
    .replace(/&#8221;/g, '"')
    .replace(/&amp;/g, '&')
    .replace(/&laquo;/g, '«')
    .replace(/&raquo;/g, '»')
    .trim();
}

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('fr-FR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  }).format(date);
}

const sortedPosts = wpPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

async function getCategoryName(categoryRefs: any[]): Promise<string> {
  if (!categoryRefs || categoryRefs.length === 0) return 'Non classé';
  try {
    const catEntry = await getEntry(categoryRefs[0]) as any;
    return catEntry?.data?.name || 'Non classé';
  } catch {
    return 'Non classé';
  }
}

async function getFeaturedImageData(featuredMedia: any): Promise<ImageData | undefined> {
  if (!featuredMedia) return undefined;
  try {
    const media = await getEntry(featuredMedia) as any;
    if (media) {
      const sizes = media.data?.media_details?.sizes;
      const selectedSize = sizes?.large || sizes?.medium_large || sizes?.medium;
      
      const imageUrl = selectedSize?.source_url || media.data?.source_url;
      const width = selectedSize?.width || media.data?.media_details?.width || 800;
      const height = selectedSize?.height || media.data?.media_details?.height || 600;
      
      return { url: imageUrl, width, height };
    }
  } catch (e) {
    console.warn(`Could not resolve featured media`);
  }
  return undefined;
}

const blogPosts: BlogPost[] = await Promise.all(
  sortedPosts.map(async (post) => {
    const categoryName = await getCategoryName(post.data.categories as any);
    const imageData = await getFeaturedImageData(post.data.featured_media);
    
    return {
      id: String(post.data.id),
      slug: post.data.slug,
      title: stripHtml(post.data.title?.rendered || ''),
      excerpt: stripHtml(post.data.excerpt?.rendered || ''),
      date: formatDate(new Date(post.data.date)),
      author: 'Équipe Villageois 2.0',
      category: categoryName,
      categories: [categoryName],
      image: imageData?.url,
      imageWidth: imageData?.width || 800,
      imageHeight: imageData?.height || 600,
    };
  })
);

const featuredPost = blogPosts[0];
const remainingPosts = blogPosts.slice(1);
---

<Layout title="Actualités">
  {featuredPost && (
    <FeaturedArticle
      title={featuredPost.title}
      date={featuredPost.date}
      author={featuredPost.author}
      category={featuredPost.category}
      excerpt={featuredPost.excerpt}
      image={featuredPost.image || "/assets/VILLAGEOIS.png"}
      imageWidth={featuredPost.imageWidth}
      imageHeight={featuredPost.imageHeight}
      readTime="5 min"
      slug={featuredPost.slug}
      transition:name="hero"
    />
  )}

  <BlogFilter 
    client:load 
    posts={remainingPosts}
    categories={categoryNames}
  />
</Layout>
